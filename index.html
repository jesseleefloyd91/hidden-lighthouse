<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Bill Donahue | Official Archive</title>
   
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-primary: #050505;
            --bg-secondary: #0f0f0f;
            --bg-tertiary: #1a1a1a;
            --text-primary: #EAEAEA;
            --text-secondary: #a1a1aa;
            --border-color: rgba(255,255,255,0.1);
            --purple: #D8B4FE;
            --gold: #D4AF37;
            --accent-glow: rgba(212, 175, 55, 0.25);
            --input-bg: rgba(255,255,255,0.07);
            --dock-bg: rgba(10, 10, 10, 0.90);
        }

        body.light-mode {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: rgba(0,0,0,0.08);
            --purple: #4c1d95;
            --gold: #b45309;
            --accent-glow: rgba(76, 29, 149, 0.1);
            --input-bg: rgba(0,0,0,0.04);
            --dock-bg: rgba(255, 255, 255, 0.90);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.5s ease, color 0.5s ease; overflow-x: hidden; height: 100vh; }
        .cinzel { font-family: 'Cinzel', serif; }
        .mono { font-family: 'Space Grotesk', monospace; }
        
        /* BACKGROUNDS */
        .stars-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; background: radial-gradient(circle at bottom center, #11001c 0%, #000000 80%); transition: opacity 0.8s; opacity: 1; }
        .photon-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; opacity: 0; transition: opacity 0.8s; background-color: #ffffff; background-image: radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), radial-gradient(at 50% 100%, hsla(225,39%,95%,1) 0, transparent 50%); }
        .photon-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(0, 0, 0, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.03) 1px, transparent 1px); background-size: 40px 40px; }
        body.light-mode .stars-container { opacity: 0; } body.light-mode .photon-bg { opacity: 1; }
        
        .planet { position: absolute; border-radius: 50%; opacity: 0.3; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent); box-shadow: 0 0 20px rgba(216, 180, 254, 0.05); animation: floatPlanet 120s linear infinite; }
        .star { position: absolute; border-radius: 50%; animation: twinkle var(--duration) ease-in-out infinite; opacity: 0; }
        @keyframes twinkle { 0%, 100% { opacity: 0; transform: scale(0.5); } 50% { opacity: var(--opacity); transform: scale(1); } }
        @keyframes floatPlanet { from { transform: translateX(-100px) rotate(0deg); } to { transform: translateX(110vw) rotate(20deg); } }

        /* CARDS */
        .masonry-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; padding-bottom: 140px; }
        @media (max-width: 640px) { .masonry-grid { grid-template-columns: 1fr; } }
        .cosmos-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; z-index: 10; }
        .cosmos-card:hover { border-color: var(--gold); transform: translateY(-4px); box-shadow: 0 10px 40px -10px var(--accent-glow); }

        /* UI */
        .dock-container { position: fixed; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 50; padding: 0 20px; }
        .dock { background: var(--dock-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); padding: 8px; border-radius: 20px; display: flex; gap: 4px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3); max-width: 100%; overflow-x: auto; scrollbar-width: none; }
        .dock-btn { padding: 10px 16px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-secondary); transition: all 0.2s; cursor: pointer; border: 1px solid transparent; white-space: nowrap; flex-shrink: 0; }
        .dock-btn:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .dock-btn.active { background: var(--text-primary); color: var(--bg-primary); }

        /* SEARCH OVERLAY */
        #search-overlay { position: fixed; inset: 0; background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px); z-index: 90; display: flex; flex-direction: column; align-items: center; padding-top: 100px; transition: opacity 0.3s; opacity: 0; pointer-events: none; }
        #search-overlay.active { opacity: 1; pointer-events: auto; }
        .big-search-input { width: 90%; max-width: 600px; background: transparent; border: none; border-bottom: 2px solid var(--gold); font-size: 2rem; color: var(--text-primary); padding: 10px; text-align: center; outline: none; font-family: 'Cinzel', serif; }
        .big-search-input::placeholder { color: var(--text-secondary); opacity: 0.5; }

        /* DIAGNOSTICS OVERLAY */
        #diagnostics-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .diag-box { width: 90%; max-width: 500px; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .progress-bar { height: 4px; background: var(--bg-tertiary); width: 100%; border-radius: 2px; overflow: hidden; margin: 20px 0; }
        .progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.3s; }

        /* ANATOMY */
        .anatomy-wrapper { position: relative; width: 300px; height: 650px; border: 1px solid var(--border-color); border-radius: 999px; background: var(--bg-secondary); box-shadow: 0 0 80px -20px var(--accent-glow); }
        @media (max-width: 768px) { .anatomy-scale-container { transform: scale(0.75); transform-origin: top center; height: 500px; } }
        .anatomy-dot { width: 24px; height: 24px; border-radius: 50%; position: absolute; left: 50%; transform: translateX(-50%); cursor: pointer; transition: all 0.3s ease; border: 2px solid rgba(255,255,255,0.5); z-index: 20; }
        .anatomy-dot:hover { transform: translateX(-50%) scale(1.5); border-color: white; }

        .view-section { display: none; padding-top: 140px; padding-bottom: 150px; width: 100%; min-height: 100vh; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        #view-home.active { display: flex; flex-direction: column; justify-content: center; align-items: center; padding-top: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none !important; }
        .profile-img { box-shadow: 0 0 50px var(--accent-glow); transition: 0.5s; border-color: var(--border-color); }
        
        /* CHIPS */
        .topic-chip { padding: 6px 12px; border-radius: 99px; font-size: 10px; font-weight: bold; text-transform: uppercase; cursor: pointer; border: 1px solid var(--border-color); color: var(--text-secondary); background: var(--bg-secondary); transition: all 0.2s; user-select: none; display: inline-flex; align-items: center; gap: 6px; }
        .topic-chip:hover { border-color: var(--purple); color: var(--text-primary); }
        .topic-chip.active { background: var(--purple); color: white; border-color: var(--purple); }
        .chip-count { opacity: 0.5; font-size: 9px; }

        .search-input { background: var(--input-bg); backdrop-filter: blur(10px); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px 20px; border-radius: 99px; font-size: 12px; width: 100%; outline: none; transition: all 0.3s; }
        .search-input:focus { border-color: var(--purple); box-shadow: 0 0 15px rgba(216, 180, 254, 0.1); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="stars-container" class="stars-container"></div>
    <div id="photon-bg" class="photon-bg"><div class="photon-grid"></div></div>

    <div id="diagnostics-overlay" class="hidden">
        <div class="diag-box">
            <i class="fa-solid fa-stethoscope text-4xl mb-4" style="color: var(--gold);"></i>
            <h3 class="cinzel text-xl font-bold mb-2" style="color: var(--text-primary);">System Diagnostic</h3>
            <p id="diag-status" class="text-xs font-mono uppercase tracking-widest mb-4" style="color: var(--text-secondary);">Initializing...</p>
            <div class="progress-bar"><div id="diag-progress" class="progress-fill"></div></div>
            <div id="diag-results" class="hidden text-left mt-4 max-h-40 overflow-y-auto custom-scrollbar text-xs font-mono" style="color: var(--text-secondary);"></div>
            <button onclick="window.app.closeDiagnostics()" class="mt-6 px-6 py-2 rounded-full font-bold uppercase tracking-widest text-xs border transition-all" style="border-color: var(--border-color); color: var(--text-primary);">Close</button>
        </div>
    </div>

    <div id="search-overlay">
        <button onclick="window.app.closeSearchOverlay()" class="absolute top-10 right-10 text-4xl" style="color: var(--text-secondary);"><i class="fa-solid fa-xmark"></i></button>
        <div class="text-center w-full px-6">
            <p class="font-mono text-xs uppercase tracking-[0.3em] mb-4" style="color: var(--gold);">Search Library Files</p>
            <input type="text" id="overlay-search-input" class="big-search-input" placeholder="Type a keyword..." onkeydown="if(event.key === 'Enter') window.app.performOverlaySearch()">
            <div class="mt-8 flex gap-4 justify-center">
                <button onclick="window.app.performOverlaySearch()" class="px-6 py-2 rounded-full font-bold uppercase tracking-widest text-xs transition-all" style="background: var(--gold); color: black;">Search Archive</button>
            </div>
        </div>
    </div>

    <div class="fixed top-0 left-0 w-full p-4 z-40 flex justify-between items-center bg-opacity-95 backdrop-blur-xl border-b shadow-sm transition-colors duration-300" style="background-color: var(--bg-primary); border-color: var(--border-color);">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="window.app.nav('home')">
            <div class="w-10 h-10 border flex items-center justify-center rotate-45 transition-all group-hover:rotate-0 shrink-0 overflow-hidden" style="border-color: var(--border-color); background: var(--bg-secondary);">
                <img src="bill_profile.jpg" class="w-full h-full object-cover -rotate-45 group-hover:rotate-0 transition-transform duration-500" alt="Bill Donahue">
            </div>
            <div>
                <h1 class="cinzel font-bold text-xs md:text-sm tracking-widest uppercase leading-tight" style="color: var(--text-primary);">Hidden<br>Meanings</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="relative group hidden md:block w-64">
                <input type="text" id="global-search" oninput="window.app.performGlobalSearch()" placeholder="SEARCH LIBRARY..." class="search-input font-mono uppercase">
                <i class="fa-solid fa-search absolute right-4 top-1/2 -translate-y-1/2 text-xs" style="color: var(--text-secondary);"></i>
            </div>
            <button onclick="window.app.toggleTheme()" class="w-10 h-10 rounded-full flex items-center justify-center border transition-all hover:bg-white/10" style="border-color: var(--border-color); color: var(--text-primary);">
                <i class="fa-solid fa-moon" id="theme-icon"></i>
            </button>
        </div>
    </div>

    <div id="app-loader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center transition-opacity duration-500" style="background-color: var(--bg-primary);">
        <div class="w-12 h-12 border-2 border-t-purple-400 rounded-full animate-spin mb-4" style="border-color: var(--border-color); border-top-color: var(--purple);"></div>
        <p class="text-xs uppercase tracking-[0.3em] font-bold animate-pulse" style="color: var(--purple);">Initializing...</p>
    </div>

    <div id="video-modal" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur-xl hidden flex items-center justify-center p-4 transition-all duration-300" onclick="if(event.target === this) window.app.closeVideo()">
        <div class="relative w-full max-w-6xl aspect-video bg-black border border-white/10 rounded-2xl overflow-hidden shadow-2xl flex flex-col">
            <button onclick="window.app.closeVideo()" class="absolute top-4 right-4 z-50 w-10 h-10 bg-black/50 text-white rounded-full hover:bg-red-600 transition-colors flex items-center justify-center border border-white/20 backdrop-blur-md">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <div id="video-frame-container" class="w-full h-full bg-black"></div>
        </div>
    </div>

    <div class="h-screen overflow-y-auto custom-scrollbar" id="scroll-wrapper">
       
        <section id="view-home" class="view-section active">
            <div class="relative z-10 max-w-[1800px] mx-auto text-center fade-in pt-10 px-4">
                <div class="mb-8 flex justify-center">
                    <div class="relative w-32 h-32 md:w-40 md:h-40 rounded-full p-1 border-2 profile-img" style="background: var(--bg-secondary);">
                        <img src="bill_profile.jpg" class="w-full h-full object-cover rounded-full opacity-90 transition-opacity grayscale hover:grayscale-0"
                             onerror="this.src='https://ui-avatars.com/api/?name=Bill+Donahue&background=000&color=d8b4fe&size=160'">
                    </div>
                </div>
                <div class="mb-6 inline-flex items-center gap-3 border px-4 py-2 rounded-full" style="border-color: var(--border-color); background: var(--input-bg);">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                    <span class="text-[10px] uppercase tracking-[0.2em] font-bold" style="color: var(--text-secondary);">System Online</span>
                </div>
                <h1 class="cinzel text-4xl md:text-8xl font-black mb-6 leading-none tracking-tight drop-shadow-2xl" style="color: var(--text-primary);">
                    HIDDEN<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-blue-400 italic">MEANINGS</span>
                </h1>
                
                <div class="max-w-lg mx-auto relative group w-full mb-8 px-4">
                    <input type="text" id="teacher-input" placeholder="Ask the Teacher (e.g. 'What is the Pineal?')..."
                           class="w-full rounded-full py-4 pl-8 pr-16 text-sm font-mono transition-all backdrop-blur-md search-input"
                           style="border-color: var(--purple);"
                           onkeydown="if(event.key === 'Enter') window.app.askTheTeacher()"
                           oninput="window.app.toggleClearButton()">
                    
                    <button id="clear-teacher-btn" onclick="window.app.resetHome()" class="absolute right-6 top-1/2 -translate-y-1/2 text-xs hover:scale-110 transition-transform hidden" style="color: var(--text-secondary);">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <div id="teacher-response-box" class="w-full text-left p-8 border-l-4 rounded-xl fade-in hidden mt-10" style="background: var(--bg-secondary); border-color: var(--border-color); border-left-color: var(--purple);">
                    <span class="font-mono text-[10px] uppercase tracking-widest block mb-4" style="color: var(--purple);">The Teacher's Response</span>
                    <div id="teacher-text" class="text-lg md:text-2xl leading-relaxed italic font-light font-serif mb-8" style="color: var(--text-primary);"></div>
                    <div class="border-t pt-4" style="border-color: var(--border-color);">
                        <span class="text-[9px] uppercase font-bold tracking-widest block mb-3" style="color: var(--text-secondary);">Related Materials</span>
                        <div id="teacher-related-grid" class="masonry-grid"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-search" class="view-section px-6 max-w-[1800px] mx-auto">
            <div class="flex justify-between items-end mb-8 border-b pb-4" style="border-color: var(--border-color);">
                <h2 class="cinzel text-2xl font-bold" style="color: var(--text-primary);">Library Search Results</h2>
                <button onclick="window.app.nav('home')" class="text-xs uppercase font-bold text-red-400">Clear Search</button>
            </div>
            <div id="global-search-list" class="masonry-grid pb-20"></div>
        </section>

        <section id="view-library" class="view-section px-6">
            <div class="max-w-[1800px] mx-auto w-full">
                <div class="mb-10 pb-8 border-b" style="border-color: var(--border-color);">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 mb-6">
                        <div>
                            <h2 class="cinzel text-3xl md:text-5xl font-bold mb-2 tracking-tight" style="color: var(--text-primary);">The Catalog</h2>
                            <p class="font-mono text-xs uppercase tracking-[0.2em]" style="color: var(--purple);">Filter by Topic</p>
                        </div>
                        <div class="flex flex-wrap gap-4 items-center">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="filter-yt" checked onchange="window.app.renderLibraryResults()" class="accent-red-600">
                                <span class="text-[10px] font-bold uppercase tracking-widest" style="color: var(--text-secondary);">YouTube (<span id="count-yt">0</span>)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="filter-hd" onchange="window.app.renderLibraryResults()" class="accent-cyan-400">
                                <span class="text-[10px] font-bold uppercase tracking-widest" style="color: var(--text-secondary);">HD Restored (<span id="count-hd">...</span>)</span>
                            </label>
                            <button onclick="window.app.clearLibraryFilters()" class="text-[10px] uppercase font-bold text-red-400 hover:text-red-300 ml-4">Clear All</button>
                        </div>
                    </div>
                    <div id="library-topics" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1"></div>
                </div>
                <div id="library-results-area">
                    <div id="library-grid" class="masonry-grid"></div>
                </div>
            </div>
        </section>

        <section id="view-anatomy" class="view-section px-6">
            <div class="max-w-[1800px] mx-auto grid lg:grid-cols-2 gap-10 items-center min-h-[70vh] w-full">
                <div class="relative flex justify-center order-2 lg:order-1 anatomy-scale-container">
                    <div id="anatomy-diagram" class="anatomy-wrapper flex justify-center items-center">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(255,255,255,0.03),transparent_70%)] rounded-full"></div>
                        <div class="absolute top-[10%] bottom-[10%] w-px bg-gradient-to-b from-transparent via-white/20 to-transparent"></div>
                        <div class="anatomy-dot" style="top: 10%; background: #a855f7; box-shadow: 0 0 20px #a855f7;" onclick="window.app.showAnatomy('crown')"></div>
                        <div class="anatomy-dot" style="top: 22%; background: #4f46e5; box-shadow: 0 0 20px #4f46e5;" onclick="window.app.showAnatomy('brow')"></div>
                        <div class="anatomy-dot" style="top: 34%; background: #3b82f6; box-shadow: 0 0 20px #3b82f6;" onclick="window.app.showAnatomy('throat')"></div>
                        <div class="anatomy-dot" style="top: 46%; background: #22c55e; box-shadow: 0 0 20px #22c55e;" onclick="window.app.showAnatomy('heart')"></div>
                        <div class="anatomy-dot" style="top: 58%; background: #eab308; box-shadow: 0 0 20px #eab308;" onclick="window.app.showAnatomy('solar')"></div>
                        <div class="anatomy-dot" style="top: 70%; background: #f97316; box-shadow: 0 0 20px #f97316;" onclick="window.app.showAnatomy('sacral')"></div>
                        <div class="anatomy-dot" style="top: 82%; background: #ef4444; box-shadow: 0 0 20px #ef4444;" onclick="window.app.showAnatomy('root')"></div>
                    </div>
                </div>
                <div class="order-1 lg:order-2 text-center lg:text-left">
                    <span class="font-mono text-xs uppercase tracking-[0.2em] mb-4 block" style="color: var(--purple);">The 7 Seals of Revelation</span>
                    <h2 class="cinzel text-4xl md:text-7xl font-bold mb-8 leading-none" style="color: var(--text-primary);">The Temple<br>Of God</h2>
                    <div id="anatomy-info" class="p-8 border rounded-xl border-l-4 relative z-20 transition-all duration-500" style="background: var(--bg-secondary); border-color: var(--border-color); border-left-color: var(--purple);">
                        <div id="anatomy-content-default">
                            <h3 class="cinzel text-xl md:text-2xl mb-4 uppercase tracking-widest font-bold" style="color: var(--text-primary);">Select a Center</h3>
                            <p class="text-sm md:text-lg leading-relaxed font-light italic" style="color: var(--text-secondary);">"Know ye not that ye are the temple of God?"<br><br>Click the energy centers on the diagram to reveal the biological decoding.</p>
                        </div>
                        <div id="anatomy-content-active" class="hidden text-left">
                            <div class="flex justify-between items-start mb-2"><span id="ana-name" class="text-xs font-bold uppercase tracking-[0.2em] opacity-50"></span><span id="ana-freq" class="text-xs font-mono opacity-30"></span></div>
                            <h3 id="ana-title" class="cinzel text-3xl mb-6 font-bold leading-none"></h3>
                            <div class="grid grid-cols-2 gap-4 mb-6 border-t pt-4" style="border-color: var(--border-color);">
                                <div><span class="block text-[9px] uppercase tracking-widest mb-1 opacity-50">Biblical Symbol</span><span id="ana-bib" class="text-sm font-serif italic"></span></div>
                                <div><span class="block text-[9px] uppercase tracking-widest mb-1 opacity-50">Church</span><span id="ana-church" class="text-sm font-serif italic"></span></div>
                            </div>
                            <p id="ana-desc" class="text-sm leading-relaxed" style="color: var(--text-secondary);"></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-meditation" class="view-section px-6">
            <div class="max-w-[1800px] mx-auto text-center pt-10">
                 <div class="mb-16">
                     <i class="fa-solid fa-quote-left text-4xl mb-6 opacity-30" style="color: var(--purple);"></i>
                     <h1 id="meditation-quote" class="cinzel text-2xl md:text-4xl font-bold leading-tight mb-6 fade-in" style="color: var(--text-primary);"></h1>
                     <p class="text-xs uppercase tracking-[0.3em] font-mono" style="color: var(--text-secondary);">- Bill Donahue</p>
                 </div>
                 <div class="border-t pt-12 text-left" style="border-color: var(--border-color);">
                     <h2 class="cinzel text-2xl mb-8" style="color: var(--text-primary);">Meditative Lectures</h2>
                     <div id="meditation-lectures-grid" class="masonry-grid"></div>
                 </div>
            </div>
        </section>

        <section id="view-videos" class="view-section px-6">
              <div class="max-w-[1800px] mx-auto w-full">
                <div class="mb-10 pb-8 border-b flex flex-col md:flex-row justify-between items-start md:items-end gap-6" style="border-color: var(--border-color);">
                    <div>
                        <h2 class="cinzel text-3xl md:text-5xl font-bold mb-2" style="color: var(--text-primary);">The Archive</h2>
                        <p class="font-mono text-xs uppercase tracking-[0.2em]" style="color: var(--purple);">Video Collection</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="toggle-yt" class="px-4 py-2 border rounded text-xs font-bold uppercase tracking-widest" style="background: #DC2626; color: white; border-color: #DC2626;" onclick="window.app.setVideoSource('youtube')">
                            <i class="fa-brands fa-youtube mr-2"></i> YouTube
                        </button>
                        <button id="toggle-arc" class="px-4 py-2 border rounded text-xs font-bold uppercase tracking-widest" style="color: var(--text-secondary); border-color: var(--border-color);" onclick="window.app.setVideoSource('archive')">
                            <i class="fa-solid fa-film mr-2"></i> HD Restored
                        </button>
                    </div>
                </div>
                <div id="video-grid" class="masonry-grid"></div>
                <div id="video-loader" class="text-center py-8 hidden">
                    <i class="fa-solid fa-circle-notch fa-spin text-2xl" style="color: var(--purple);"></i>
                    <p class="mt-2 text-[10px] font-mono uppercase" style="color: var(--text-secondary);">Loading Data...</p>
                </div>
              </div>
        </section>

        <section id="view-resources" class="view-section px-6 max-w-[1800px] mx-auto">
            <h2 class="cinzel text-3xl md:text-4xl font-bold mb-16 text-center uppercase tracking-widest" style="color: var(--text-primary);">Primary Sources</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <a href="https://www.facebook.com/groups/356472414984195" target="_blank" class="cosmos-card p-8 group block">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-10 rounded-full bg-[#1877F2]/20 flex items-center justify-center text-[#1877F2]"><i class="fa-brands fa-facebook-f"></i></div>
                        <span class="group-hover:text-purple-400 transition-colors" style="color: var(--text-secondary);">↗</span>
                    </div>
                    <h3 class="cinzel text-2xl mb-2 group-hover:text-purple-400 transition-colors" style="color: var(--text-primary);">Facebook Community</h3>
                    <p class="font-mono text-xs uppercase tracking-widest" style="color: var(--text-secondary);">Official Discussion Group</p>
                </a>
                <a href="https://www.hiddenmeanings.com/" target="_blank" class="cosmos-card p-8 group block">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-serif" style="background: var(--bg-tertiary); color: var(--text-primary);">H</div>
                        <span class="group-hover:text-purple-400 transition-colors" style="color: var(--text-secondary);">↗</span>
                    </div>
                    <h3 class="cinzel text-2xl mb-2 group-hover:text-purple-400 transition-colors" style="color: var(--text-primary);">HiddenMeanings.com</h3>
                    <p class="font-mono text-xs uppercase tracking-widest" style="color: var(--text-secondary);">Main Portal</p>
                </a>
                 <a href="https://lifestyleluminaries.blogspot.com/p/bill-donahue.html" target="_blank" class="cosmos-card p-8 group block">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-serif" style="background: var(--bg-tertiary); color: var(--text-primary);">L</div>
                        <span class="group-hover:text-purple-400 transition-colors" style="color: var(--text-secondary);">↗</span>
                    </div>
                    <h3 class="cinzel text-2xl mb-2 group-hover:text-purple-400 transition-colors" style="color: var(--text-primary);">Lifestyle Luminaries</h3>
                    <p class="font-mono text-xs uppercase tracking-widest" style="color: var(--text-secondary);">Video Archive</p>
                </a>
                <a href="https://thehiddenlighthouse.blogspot.com/2012/09/the-hidden-lighthouse.html?m=1" target="_blank" class="cosmos-card p-8 group block">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-serif" style="background: var(--bg-tertiary); color: var(--text-primary);">B</div>
                        <span class="group-hover:text-purple-400 transition-colors" style="color: var(--text-secondary);">↗</span>
                    </div>
                    <h3 class="cinzel text-2xl mb-2 group-hover:text-purple-400 transition-colors" style="color: var(--text-primary);">Lighthouse Blog</h3>
                    <p class="font-mono text-xs uppercase tracking-widest" style="color: var(--text-secondary);">2012 Writings</p>
                </a>
                <a href="https://archive.org/details/1-revised-bill-donahue-speaks-book-of-secret-doctrines/page/18/mode/1up?ui=embed&wrapper=false" target="_blank" class="cosmos-card p-8 group block">
                    <div class="flex justify-between items-start mb-6">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center font-serif" style="background: var(--bg-tertiary); color: var(--text-primary);">S</div>
                        <span class="group-hover:text-purple-400 transition-colors" style="color: var(--text-secondary);">↗</span>
                    </div>
                    <h3 class="cinzel text-2xl mb-2 group-hover:text-purple-400 transition-colors" style="color: var(--text-primary);">Secret Doctrines</h3>
                    <p class="font-mono text-xs uppercase tracking-widest" style="color: var(--text-secondary);">PDF Book</p>
                </a>
            </div>
        </section>
    </div>

    <div class="dock-container">
        <div class="dock">
            <button class="dock-btn active" id="btn-home" onclick="window.app.nav('home')">Home</button>
            <button class="dock-btn" id="btn-library" onclick="window.app.nav('library')">Library</button>
            <button class="dock-btn" id="btn-videos" onclick="window.app.nav('videos')">Videos</button>
            <button class="dock-btn" style="color: var(--gold);" onclick="window.app.openSearchOverlay()">
                <i class="fa-solid fa-magnifying-glass text-lg"></i>
            </button>
            <button class="dock-btn" id="btn-anatomy" onclick="window.app.nav('anatomy')">Temple</button>
            <button class="dock-btn" id="btn-meditation" onclick="window.app.nav('meditation')">Meditation</button> 
            <button class="dock-btn" id="btn-resources" onclick="window.app.nav('resources')">Links</button>
            <div class="w-px mx-1" style="background: var(--border-color);"></div>
            <button class="dock-btn text-red-400 hover:text-red-300" onclick="window.app.scanForBrokenLinks()" title="Scan for Bad Links"><i class="fa-solid fa-stethoscope"></i></button>
        </div>
    </div>

    <script>
        function createStars() {
            const container = document.getElementById('stars-container');
            if(!container) return;
            container.innerHTML = '';
            const colors = ['#ffffff', '#ffcccb', '#ffd700', '#ff8c00'];
            for(let i=0; i<150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                const size = Math.random() * 2 + 0.5;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                star.style.boxShadow = `0 0 ${size*2}px ${star.style.backgroundColor}`;
                star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
                container.appendChild(star);
            }
            for(let i=0; i<3; i++) {
                const planet = document.createElement('div');
                planet.className = 'planet';
                const size = Math.random() * 80 + 40;
                planet.style.width = `${size}px`;
                planet.style.height = `${size}px`;
                planet.style.top = `${Math.random() * 80}%`;
                planet.style.left = `-${size}px`;
                planet.style.animationDuration = `${Math.random() * 100 + 100}s`;
                container.appendChild(planet);
            }
        }
        
        window.app = {
            data: [], 
            currentVideoSource: 'youtube', 
            archiveVideos: [], archivePage: 1, archiveLoading: false, archiveHasMore: true,
            archiveTotal: '...',
            isLightMode: false,
            selectedLibraryTopics: new Set(),
            
            synthBrain: {
                "pineal": "The Pineal Gland is the light receptor of the body. It is the 'Single Eye' (Matthew 6:22). When filled with light, the whole body is full of light. It secretes melatonin, the chemical of the Christos.",
                "144000": "The 144,000 is not a number of people. It is a biological frequency. It represents the 12 cranial nerves multiplied by the 12 signs of the zodiac (12 x 12 = 144), raised to the power of the divine (1000). It is the measure of the light energy in the redeemed mind.",
                "144,000": "The 144,000 is not a number of people. It is a biological frequency. It represents the 12 cranial nerves multiplied by the 12 signs of the zodiac (12 x 12 = 144), raised to the power of the divine (1000). It is the measure of the light energy in the redeemed mind.",
                "meditation": "Meditation is the shutting down of the five senses. You must enter the 'closet' and shut the door. It is the cessation of thought to allow the photon energy from above to enter the pineal gland.",
                "egypt": "Egypt in the Bible is your lower physical body. It is the house of bondage. The Exodus is the movement of the seed (Israel) out of the solar plexus (Egypt) up to the brain (Promised Land).",
                "jesus": "Jesus is the Greek word Iesous, representing the sun/son within you. It is the solar energy that is born in the manger (solar plexus) and must ascend the 33 vertebrae to the skull (Golgotha).",
                "christ": "Christ is a substance, not a person. It is the 'Christos' oil, the sacred secretion produced by the claustrum in the brain, which flows down the spine and must be returned.",
                "east": "The East represents the right hemisphere of the brain. The sun rises in the East. We must move our consciousness from the carnal West (left brain) to the spiritual East.",
                "zodiac": "The Zodiac is the path of the soul. The Bible is an astrological book. The 12 disciples are the 12 signs of the zodiac within you. You must master these energies.",
                "light": "God is Light. This is literal physics. Photons are angles of light (Angels). We are beings of light trapped in density.",
                "virgo": "Virgo is the Virgin. In the body, this corresponds to the solar plexus where the seed (bread/Bethlehem) is born. It is the beginning of the alchemical process.",
                "pisces": "Pisces is the two fish. It represents the feet, but also the age of the fish, the age of Christianity which we are leaving as we enter Aquarius (the water bearer/mind).",
                "aquarius": "Aquarius is the man bearing a pitcher of water (Luke 22:10). This represents the age of the Mind, the outpouring of spirit/knowledge. The water is truth.",
                "passover": "Passover is the sun 'passing over' the equator at the Spring Equinox. In you, it is the energy passing over from the lower chakras to the higher chakras.",
                "crucifixion": "Crucifixion happens in the skull (Golgotha). It is the crossing of the optic thalamus nerve. The energy crosses over to enlighten the higher mind.",
                "resurrection": "Resurrection is the awakening of the dormant brain cells. The 'dead' listed in scripture are those living in lower consciousness. To rise is to activate the pineal.",
                "atom": "The Atom is the basic building block, but it reflects the solar system. Adam is Atom. We are all Adams/Atoms. The story of Adam is the story of the Atom.",
                "electron": "The electron is the negative charge, the female principle, Eve. It circles the nucleus (Adam).",
                "proton": "The proton is the positive charge, the male principle.",
                "neutron": "The neutron is the neutral force, the balance. It is the Christ consciousness that unifies the duality of proton and electron.",
                "ion": "Ion is John. John the Baptist. The Ion (John) prepares the way for the coming of the light.",
                "salt": "You are the salt of the earth. Salt is the preservative. It represents the chemical balance required for the electrical firing of the nervous system.",
                "single eye": "If thine eye be single, thy body shall be full of light. This is the Pineal Gland activated, seeing beyond duality into unity.",
                "furnace": "The fiery furnace of Shadrach, Meshach, and Abednego is the solar plexus. When we overcome the lower fires (passions), we walk with the fourth man (spirit) and are not burned.",
                "lion": "The Lion represents the sign of Leo, the heart. It is the King of Beasts (the lower animal nature mastered by the heart). The Lion of the Tribe of Judah.",
                "lamb": "The Lamb is Aries, the Ram. It represents the higher mind, the cerebrum. The marriage of the Lamb is the union of the lower and higher self.",
                "wilderness": "The Wilderness is the state of the mind before enlightenment. It is the 40 years (states of consciousness) we wander before entering the Promised Land (the brain).",
                "jordan": "The River Jordan represents the spinal cord. We must cross the Jordan (raise the energy up the spine) to enter the Promised Land.",
                "jerusalem": "Jerusalem is 'Jeru-Salem', the City of Peace. It is not a city in the Middle East; it is the center of peace within the brain, the higher consciousness.",
                "israel": "Is-Ra-El. Isis (Moon), Ra (Sun), El (God). It represents the integration of the feminine, masculine, and divine within the human body.",
                "judas": "Judas represents the sign of Scorpio (the backbiter). It is the generative force that 'betrays' the seed if it is wasted in lower desires.",
                "peter": "Peter represents the pineal gland/stone. 'Upon this rock I will build my church.' He is the unstable stone that becomes stable.",
                "thomas": "Thomas represents the twins (Gemini). He is the doubter, the analytical lower mind that must see to believe.",
                "lucifer": "Lucifer means 'Light Bearer'. It is not a devil. It is the energy falling into matter (descent) which must be raised back up.",
                "satan": "Satan means 'adversary'. It is your own lower ego, the carnal mind that opposes the spirit. It is the resistance required for growth.",
                "devil": "The Devil is 'D-Evil', the energy lived backward (LIVE vs EVIL). It is living for the senses rather than the spirit.",
                "hell": "Hell is the lower state of consciousness. It is the burning of desire and passion in the solar plexus.",
                "heaven": "Heaven is 'heaved up'. It is the higher state of consciousness in the brain.",
                "ark": "The Ark of the Covenant is the area of the brain containing the pituitary and pineal glands. It is where the electrical connection (Arc) takes place.",
                "moses": "Moses represents the Law, the intellectual understanding that leads us to the water but cannot cross over. Joshua (Jesus) takes us over.",
                "manna": "Manna is the 'hidden manna' from the brain. It is the secretions of the brain that nourish the body when we are in the wilderness of meditation.",
                "oil": "The Oil is the Christos, the sacred secretion. It must not be spilled (wasted). It lights the lamp of the body.",
                "temple": "Know ye not that ye are the Temple of God? The external churches are metaphors for your own body.",
                "stone": " The stone that the builders rejected is the Pineal Gland. It is the cornerstone of the spiritual temple.",
                "water": "Water represents truth. Jesus walking on water is the spirit rising above the turbulent emotions/truth.",
                "wine": "Wine represents the spirit fermented and potent. Turning water into wine is elevating mere facts into spiritual realization.",
                "bread": "Bread represents the seed, the physical substance born in Virgo (House of Bread).",
                "fish": "Fish represents the spiritual thought swimming in the sea of the mind. 153 fish represents the full catch of spiritual activation.",
                "net": "The net is the nervous system catching the spiritual impulses.",
                "right side": "Cast your net on the right side. Operate from the right hemisphere of the brain (intuitive) rather than the left (logical).",
                "moon": "The Moon represents the emotions and the soul. It reflects the light of the sun (spirit) but has no light of its own.",
                "sun": "The Sun represents the Spirit, the Christ consciousness. It is the source of all life and light.",
                "stars": "The stars represent the chakras and the cranial nerves. 'He determines the number of the stars and calls them each by name.'",
                "cloud": "A cloud represents the confusion of the lower mind that hides the sun. 'He comes with clouds' - spirit appearing through the veil of matter.",
                "mountain": "A mountain represents a high state of meditation. Jesus went up the mountain to pray. We must elevate our consciousness.",
                "tree": "The Tree of Life is the spine and the nervous system. The fruit is the enlightened action.",
                "serpent": "The serpent represents the Kundalini energy at the base of the spine. Lifted up (Moses), it becomes healing. Crawling on the belly, it is deception.",
                "default": "The hidden meaning of this concept lies within the biological decoding of scripture. Look not at the literal letter, but the spirit within the form."
            },

            quotes: [
                "When you pray, enter into your closet, and when you have shut the door, pray to your Father which is in secret.",
                "The Kingdom of God is within you.",
                "If thine eye be single, thy whole body shall be full of light.",
                "The Bible is not a book of history, it is a book of biology.",
                "Be still, and know that I am God.",
                "You are the Temple of the Living God.",
                "Look at the things that are not seen, for the things which are seen are temporal.",
                "As above, so below."
            ],

            anatomyData: {
                "root": { title: "Root", name: "Muladhara", color: "#ef4444", freq: "400-484 THz", biblical: "Egypt", church: "Ephesus", desc: "The starting point. Egypt represents physical bondage." },
                "sacral": { title: "Sacral", name: "Svadhisthana", color: "#f97316", freq: "484-508 THz", biblical: "Wilderness", church: "Smyrna", desc: "Seat of emotions. Wilderness of the mind." },
                "solar": { title: "Solar Plexus", name: "Manipura", color: "#eab308", freq: "508-526 THz", biblical: "The Manger", church: "Pergamos", desc: "The place of the Sun/Son born in the manger." },
                "heart": { title: "Heart", name: "Anahata", color: "#22c55e", freq: "526-606 THz", biblical: "Jerusalem", church: "Thyatira", desc: "The balance point. The Green Ray." },
                "throat": { title: "Throat", name: "Vishuddha", color: "#3b82f6", freq: "606-668 THz", biblical: "Jordan", church: "Sardis", desc: "Power of the Word. Crossing over." },
                "brow": { title: "Brow", name: "Ajna", color: "#4f46e5", freq: "668-789 THz", biblical: "Single Eye", church: "Philadelphia", desc: "The Command Center. Pituitary." },
                "crown": { title: "Crown", name: "Sahasrara", color: "#a855f7", freq: "789+ THz", biblical: "Peniel", church: "Laodicea", desc: "The Pineal Gland. Face to Face." }
            },
           
            // --- CORE RENDERER ---
            renderCard: function(videoObj, isArchive = false) {
                let id = isArchive ? videoObj.identifier : videoObj.id;
                let title = isArchive ? videoObj.title : videoObj.title;
                let thumb = isArchive ? `https://archive.org/services/img/${id}` : videoObj.thumbnail;
                let linkUrl = isArchive ? `https://archive.org/details/${id}` : `https://www.youtube.com/watch?v=${id}`;
                let topic = this.getTopicByVideoID(null, title);
                if (!isArchive && videoObj.id) topic = this.getTopicByVideoID(videoObj.id, title);

                let crossRefBtn = '';
                if (isArchive && videoObj['external-identifier'] && videoObj['external-identifier'].includes('urn:youtube:')) {
                    const ytId = videoObj['external-identifier'].replace('urn:youtube:', '');
                    crossRefBtn = `<button onclick="event.stopPropagation(); window.open('https://youtube.com/watch?v=${ytId}', '_blank')" class="text-[9px] border px-2 py-1 rounded transition-colors uppercase font-bold tracking-widest" style="border-color: #7f1d1d; color: #f87171;"><i class="fa-brands fa-youtube mr-1"></i> Source</button>`;
                }

                return `
                <div class="cosmos-card group">
                    <div class="relative aspect-video overflow-hidden cursor-pointer bg-black" onclick="window.app.openVideo('${id}', '${isArchive ? 'archive' : 'youtube'}')">
                        <img src="${thumb}" class="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" onerror="this.src='https://archive.org/images/not_found.png'" />
                        <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fa-solid ${isArchive ? 'fa-film text-cyan-400' : 'fa-play text-white'} text-4xl opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-lg"></i>
                        </div>
                        ${isArchive ? '<div class="absolute top-2 right-2 bg-black/80 text-cyan-400 text-[9px] px-2 py-1 rounded font-mono uppercase tracking-widest border border-cyan-900/50">Restored</div>' : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-1" style="background: var(--bg-secondary); border-top: 1px solid var(--border-color);">
                        <h3 class="text-sm font-medium line-clamp-2 mb-3" style="color: var(--text-primary);">${title}</h3>
                        <div class="mt-auto pt-2 flex flex-wrap gap-2 justify-between items-center" style="border-top: 1px solid var(--border-color);">
                            ${this.createTagButton(topic)}
                            ${crossRefBtn}
                        </div>
                        <div class="mt-3 pt-2 text-right" style="border-top: 1px solid var(--border-color);">
                            <a href="${linkUrl}" target="_blank" onclick="event.stopPropagation();" class="text-[9px] font-mono transition-colors" style="color: var(--text-secondary);">ID: ${id} <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-[8px]"></i></a>
                        </div>
                    </div>
                </div>`;
            },

            // --- UTILS ---
            getVideoID: function(url) {
                if (!url) return null;
                const str = url.toString().trim();
                if (/^[a-zA-Z0-9_-]{11}$/.test(str)) return str;
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = str.match(regExp);
                return (match && match[2].length === 11) ? match[2] : null;
            },

            createTagButton: function(topic) {
                if(!topic || topic === "General") return `<span class="text-[9px] font-mono uppercase tracking-widest block py-1.5 opacity-30">Uncatalogued</span>`;
                const safeTopic = topic.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                // FIXED: Direct call to label click logic
                return `<button class="inline-flex items-center gap-2 text-[9px] font-bold uppercase tracking-widest px-3 py-1.5 rounded transition-all justify-center cursor-pointer relative z-20" style="background: var(--input-bg); color: var(--purple); border: 1px solid var(--border-color);" onclick="event.stopPropagation(); window.app.selectLibraryTopic('${safeTopic}')"><i class="fa-solid fa-tag"></i> ${topic}</button>`;
            },

            getTopicByVideoID: function(vidId, vidTitle) {
                if (!this.data || this.data.length === 0) return null;
                const matchById = this.data.find(row => { const csvId = this.getVideoID(row.URL); return csvId === vidId; });
                if (matchById) return matchById.TOPIC;
                if (vidTitle) {
                    const cleanVidTitle = vidTitle.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const matchByTitle = this.data.find(row => { const cleanRowTitle = row['TITLE OF VIDEO'].toLowerCase().replace(/[^a-z0-9]/g, ''); return cleanRowTitle.includes(cleanVidTitle) || cleanVidTitle.includes(cleanRowTitle); });
                    if (matchByTitle) return matchByTitle.TOPIC;
                }
                return null;
            },

            toggleTheme: function() {
                this.isLightMode = !this.isLightMode;
                document.body.classList.toggle('light-mode');
                document.getElementById('theme-icon').className = this.isLightMode ? 'fa-solid fa-sun text-yellow-500' : 'fa-solid fa-moon';
            },

            nav: function(id) { 
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active')); 
                document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active')); 
                document.getElementById('view-' + id).classList.add('active'); 
                
                if (id === 'home') {
                    this.resetHome();
                    document.getElementById('btn-home').classList.add('active');
                } else if (id === 'search') {
                    const btn = document.querySelectorAll('.dock-btn')[3]; 
                    if(btn) btn.classList.add('active');
                } else {
                    document.getElementById('btn-' + id)?.classList.add('active'); 
                }
                
                if (id === 'meditation') {
                    document.getElementById('meditation-quote').innerText = `"${this.quotes[Math.floor(Math.random() * this.quotes.length)]}"`;
                    this.renderMeditationLectures();
                }
                // FIXED: RENDER LIBRARY EVEN IF NO TOPICS SELECTED (Shows All)
                if (id === 'library') {
                    this.renderLibraryInterface();
                }
                window.scrollTo(0,0); 
            },
            
            showAnatomy: function(key) { const data = this.anatomyData[key]; if(!data) return; document.getElementById('anatomy-content-default').classList.add('hidden'); const content = document.getElementById('anatomy-content-active'); content.classList.remove('hidden'); document.getElementById('ana-name').innerText = data.name; document.getElementById('ana-freq').innerText = data.freq; document.getElementById('ana-title').innerText = data.title; document.getElementById('ana-bib').innerText = data.biblical; document.getElementById('ana-church').innerText = data.church; document.getElementById('ana-desc').innerText = data.desc; const box = document.getElementById('anatomy-info'); box.style.borderColor = data.color; box.style.boxShadow = `0 0 30px -10px ${data.color}`; document.getElementById('ana-title').style.color = data.color; },

            renderMeditationLectures: function() {
                const grid = document.getElementById('meditation-lectures-grid');
                if(!grid || this.data.length === 0) return;
                const keywords = ['meditation', 'silence', 'pineal', 'single eye', 'upper room', 'watch', 'prayer'];
                const relatedVideos = this.data.filter(row => {
                    const topic = (row.TOPIC || '').toLowerCase();
                    const title = (row['TITLE OF VIDEO'] || '').toLowerCase();
                    return keywords.some(kw => topic.includes(kw) || title.includes(kw));
                }).slice(0, 12);
                grid.innerHTML = relatedVideos.map(v => {
                    const obj = { id: this.getVideoID(v.URL), title: v['TITLE OF VIDEO'], thumbnail: `https://img.youtube.com/vi/${this.getVideoID(v.URL)}/mqdefault.jpg` };
                    return this.renderCard(obj, false);
                }).join('');
            },

            openVideo: function(id, type) {
                if(!id || id === 'null') return;
                if (!type) type = (this.currentVideoSource === 'archive' && !id.match(/^[a-zA-Z0-9_-]{11}$/)) ? 'archive' : 'youtube';
                const container = document.getElementById('video-frame-container');
                let src = type === 'archive' ? `https://archive.org/embed/${id}?autoplay=1` : `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
                container.innerHTML = `<iframe src="${src}" class="w-full h-full" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                document.getElementById('video-modal').classList.remove('hidden');
            },
            closeVideo: function() { document.getElementById('video-frame-container').innerHTML = ''; document.getElementById('video-modal').classList.add('hidden'); },

            // --- BROKEN LINK SCANNER ---
            scanForBrokenLinks: async function() {
                const overlay = document.getElementById('diagnostics-overlay');
                const status = document.getElementById('diag-status');
                const progressFill = document.getElementById('diag-progress');
                const resultsBox = document.getElementById('diag-results');
                
                overlay.classList.remove('hidden');
                resultsBox.classList.add('hidden');
                status.innerText = "Initializing Scanner...";
                progressFill.style.width = "0%";
                
                const allEntries = this.data.map(row => ({
                    id: this.getVideoID(row.URL),
                    title: row['TITLE OF VIDEO'],
                    topic: row.TOPIC,
                    url: row.URL
                }));

                let brokenLinks = allEntries.filter(e => !e.id).map(e => ({...e, reason: "Missing/Invalid URL"}));
                const validEntries = allEntries.filter(e => e.id);
                
                const total = validEntries.length;
                const batchSize = 50;
                let processed = 0;
                
                status.innerText = `Scanning ${total} videos...`;

                for (let i = 0; i < total; i += batchSize) {
                    const batch = validEntries.slice(i, i + batchSize);
                    const batchIds = batch.map(item => item.id).join(',');
                    const url = `https://www.googleapis.com/youtube/v3/videos?key=${this.youtube.apiKey}&part=id&id=${batchIds}`;
                    try {
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.items) {
                            const foundIds = new Set(data.items.map(item => item.id));
                            batch.forEach(video => { if (!foundIds.has(video.id)) brokenLinks.push({...video, reason: "Video Unavailable"}); });
                        }
                    } catch (e) { console.error("Batch Check Failed", e); }
                    processed += batch.length;
                    const pct = Math.round((processed / total) * 100);
                    progressFill.style.width = `${pct}%`;
                    status.innerText = `Scanning... ${pct}% (${processed}/${total})`;
                }
                
                status.innerText = `Scan Complete. Found ${brokenLinks.length} Broken Links.`;
                resultsBox.classList.remove('hidden');
                
                if (brokenLinks.length === 0) {
                    resultsBox.innerHTML = '<div class="text-green-400 p-4">All systems operational. No broken links found.</div>';
                } else {
                    let csvContent = "data:text/csv;charset=utf-8,TITLE,ID,TOPIC,URL,REASON\n" + brokenLinks.map(e => `"${e.title.replace(/"/g, '""')}","${e.id || 'NULL'}","${e.topic}","${e.url}","${e.reason}"`).join("\n");
                    const encodedUri = encodeURI(csvContent);
                    resultsBox.innerHTML = `<div class="mb-4"><a href="${encodedUri}" download="broken_links_report.csv" class="text-red-400 border border-red-900 px-4 py-2 rounded uppercase font-bold text-[10px] hover:bg-red-900 hover:text-white transition-colors"><i class="fa-solid fa-download mr-2"></i> Download Report (.csv)</a></div><ul class="text-left text-[10px] font-mono text-stone-400 space-y-1">${brokenLinks.slice(0, 10).map(l => `<li><span class="text-red-500">X</span> ${l.title} (${l.reason})</li>`).join('')}${brokenLinks.length > 10 ? `<li>...and ${brokenLinks.length - 10} more</li>` : ''}</ul>`;
                }
            },
            
            closeDiagnostics: function() {
                document.getElementById('diagnostics-overlay').classList.add('hidden');
            },

            // --- LIBRARY FEATURE ---
            // UPDATED: Now clears filters before setting new one to allow "Jump to Topic" behavior
            selectLibraryTopic: function(topic) {
                this.selectedLibraryTopics.clear(); // Clear existing filters
                this.selectedLibraryTopics.add(topic); // Add new filter
                this.nav('library'); // Go to library
                // FORCE RE-RENDER
                setTimeout(() => this.renderLibraryInterface(), 50);
            },
            renderLibraryInterface: function() {
                const topics = [...new Set(this.data.map(i => i.TOPIC).filter(t => t))].sort((a, b) => a.localeCompare(b)); 
                const container = document.getElementById('library-topics');
                
                document.getElementById('count-yt').innerText = this.data.length;
                document.getElementById('count-hd').innerText = this.archiveTotal;

                container.innerHTML = topics.map(t => {
                    const isActive = this.selectedLibraryTopics.has(t);
                    const count = this.data.filter(r => r.TOPIC === t).length;
                    // Fixed onclick escaping
                    return `<div class="topic-chip ${isActive ? 'active' : ''}" onclick="window.app.toggleLibraryTopic('${t.replace(/'/g, "\\'")}')">
                        ${t} <span class="chip-count">(${count})</span>
                    </div>`;
                }).join('');
                
                this.renderLibraryResults();
            },
            toggleLibraryTopic: function(topic) {
                if (this.selectedLibraryTopics.has(topic)) this.selectedLibraryTopics.delete(topic);
                else this.selectedLibraryTopics.add(topic);
                this.renderLibraryInterface();
            },
            clearLibraryFilters: function() {
                this.selectedLibraryTopics.clear();
                this.renderLibraryInterface();
            },
            renderLibraryResults: function() {
                const grid = document.getElementById('library-grid');
                // Ensure hidden elements are reset
                const placeholder = document.getElementById('library-placeholder');
                if(placeholder) placeholder.classList.add('hidden');
                grid.classList.remove('hidden');
                
                const showYT = document.getElementById('filter-yt').checked;
                const showHD = document.getElementById('filter-hd').checked;
                let results = [];

                let ytMatches = this.data;
                if (this.selectedLibraryTopics.size > 0) {
                    ytMatches = ytMatches.filter(row => this.selectedLibraryTopics.has(row.TOPIC));
                }
                
                if (showYT) {
                    results.push(...ytMatches.map(row => ({ 
                        id: this.getVideoID(row.URL), 
                        title: row['TITLE OF VIDEO'], 
                        thumbnail: `https://img.youtube.com/vi/${this.getVideoID(row.URL)}/mqdefault.jpg`,
                        type: 'youtube'
                    })));
                }

                let hdMatches = this.archiveVideos;
                if (this.selectedLibraryTopics.size > 0) {
                    hdMatches = hdMatches.filter(v => {
                        const titleLower = v.title.toLowerCase();
                        for (let topic of this.selectedLibraryTopics) {
                            if (titleLower.includes(topic.toLowerCase())) return true;
                        }
                        return false;
                    });
                }

                if (showHD) {
                    results.push(...hdMatches.map(v => ({...v, type: 'archive'})));
                }

                if (results.length === 0) { 
                    grid.innerHTML = '<div class="col-span-full text-center py-20 text-stone-500">No videos found.</div>'; 
                    return; 
                }
                
                const displaySet = results.length > 100 ? results.slice(0, 100) : results;
                
                grid.innerHTML = displaySet.map(v => this.renderCard(v, v.type === 'archive')).join('');
            },

            // --- SEARCH OVERLAY LOGIC ---
            openSearchOverlay: function() {
                const overlay = document.getElementById('search-overlay');
                overlay.classList.add('active');
                setTimeout(() => document.getElementById('overlay-search-input').focus(), 100);
            },
            closeSearchOverlay: function() {
                document.getElementById('search-overlay').classList.remove('active');
            },
            performOverlaySearch: function() {
                const query = document.getElementById('overlay-search-input').value.trim();
                if (!query) return;
                
                this.closeSearchOverlay();
                this.nav('search');
                
                const searchInput = document.getElementById('global-search');
                if(searchInput) searchInput.value = query; 
                
                const list = document.getElementById('global-search-list');
                let combinedResults = [];
                this.data.forEach(row => { 
                    if ((row['TITLE OF VIDEO']||"").toLowerCase().includes(query.toLowerCase()) || 
                        (row.TOPIC||"").toLowerCase().includes(query.toLowerCase())) { 
                        combinedResults.push({ id: this.getVideoID(row.URL), title: row['TITLE OF VIDEO'], thumbnail: `https://img.youtube.com/vi/${this.getVideoID(row.URL)}/mqdefault.jpg` }); 
                    }
                });
                
                list.innerHTML = combinedResults.length === 0 ? '<div class="p-8 text-center text-stone-500">No matches found.</div>' : combinedResults.map(r => this.renderCard(r, false)).join('');
            },

            // --- ASK THE TEACHER ---
            askTheTeacher: function() {
                const input = document.getElementById('teacher-input');
                let q = input.value.trim().toLowerCase();
                if (!q) return;
                
                let match = null;
                for (const key in this.synthBrain) {
                    if (q.includes(key)) { match = this.synthBrain[key]; break; }
                }
                const response = match || this.synthBrain['default'];
                
                document.getElementById('teacher-response-box').classList.remove('hidden');
                document.getElementById('teacher-text').innerHTML = `"${response}"`;
                
                const related = this.data.filter(v => v['TITLE OF VIDEO'].toLowerCase().includes(q) || v.TOPIC.toLowerCase().includes(q)).slice(0, 4);
                const grid = document.getElementById('teacher-related-grid');
                grid.innerHTML = related.length > 0 ? related.map(v => {
                    const obj = { id: this.getVideoID(v.URL), title: v['TITLE OF VIDEO'], thumbnail: `https://img.youtube.com/vi/${this.getVideoID(v.URL)}/mqdefault.jpg` };
                    return this.renderCard(obj, false);
                }).join('') : '<p class="text-xs text-stone-500 italic">No specific videos found.</p>';
            },
            
            resetHome: function() {
                const input = document.getElementById('teacher-input');
                input.value = '';
                document.getElementById('teacher-response-box').classList.add('hidden');
                document.getElementById('clear-teacher-btn').classList.add('hidden');
            },
            toggleClearButton: function() {
                const val = document.getElementById('teacher-input').value;
                const btn = document.getElementById('clear-teacher-btn');
                if (val.length > 0) btn.classList.remove('hidden');
                else btn.classList.add('hidden');
            },

            performGlobalSearch: function() {
                const input = document.getElementById('global-search'); 
                let q = input.value.trim();
                if (!q) return;
                this.nav('search');
                const list = document.getElementById('global-search-list');
                let combinedResults = [];
                this.data.forEach(row => { if ((row['TITLE OF VIDEO']||"").toLowerCase().includes(q.toLowerCase()) || (row.TOPIC||"").toLowerCase().includes(q.toLowerCase())) { combinedResults.push({ id: this.getVideoID(row.URL), title: row['TITLE OF VIDEO'], thumbnail: `https://img.youtube.com/vi/${this.getVideoID(row.URL)}/mqdefault.jpg` }); }});
                list.innerHTML = combinedResults.length === 0 ? '<div class="p-8 text-center text-stone-500">No matches found.</div>' : combinedResults.map(r => this.renderCard(r, false)).join('');
            },

            setVideoSource: function(source) {
                this.currentVideoSource = source;
                const btnYT = document.getElementById('toggle-yt');
                const btnArc = document.getElementById('toggle-arc');
                btnYT.style.background = 'transparent'; btnYT.style.color = 'var(--text-secondary)'; btnYT.style.borderColor = 'var(--border-color)';
                btnArc.style.background = 'transparent'; btnArc.style.color = 'var(--text-secondary)'; btnArc.style.borderColor = 'var(--border-color)';
                if (source === 'youtube') { btnYT.style.background = '#DC2626'; btnYT.style.color = 'white'; btnYT.style.borderColor = '#DC2626'; }
                else { btnArc.style.background = '#22d3ee'; btnArc.style.color = 'black'; btnArc.style.borderColor = '#22d3ee'; }
                if (source === 'archive' && this.archiveVideos.length === 0) this.fetchArchiveVideos();
                this.renderMergedGrid();
            },
            fetchArchiveVideos: async function() {
                if (this.archiveLoading || !this.archiveHasMore) return;
                this.archiveLoading = true;
                document.getElementById('video-loader').classList.remove('hidden');
                // FIXED: Updated query to search by SUBJECT not UPLOADER
                const query = 'subject:"bill_donahue" AND mediatype:"movies"';
                const url = `https://archive.org/advancedsearch.php?q=${encodeURIComponent(query)}&fl[]=identifier&fl[]=title&fl[]=description&fl[]=external-identifier&fl[]=downloads&sort[]=-addeddate&output=json&rows=50&page=${this.archivePage}`;
                try {
                    const res = await fetch(url); const data = await res.json();
                    if(data.response.numFound) this.archiveTotal = data.response.numFound;
                    if (data.response && data.response.docs && data.response.docs.length > 0) { this.archiveVideos.push(...data.response.docs); this.archivePage++; } else { this.archiveHasMore = false; }
                    if (this.currentVideoSource === 'archive') this.renderMergedGrid();
                } catch (e) { console.error("Archive Error", e); }
                this.archiveLoading = false; document.getElementById('video-loader').classList.add('hidden');
            },
            renderMergedGrid: function() {
                const grid = document.getElementById("video-grid");
                grid.innerHTML = '';
                const isArchive = (this.currentVideoSource === 'archive');
                const videos = isArchive ? this.archiveVideos : this.youtube.videos;
                if (videos.length === 0 && !this.archiveLoading && isArchive) { grid.innerHTML = '<div class="col-span-full text-center py-20 text-stone-500">No Restored Videos Found Yet.<br><span class="text-xs">Uploads take ~24hrs to appear in search.</span></div>'; return; }
                grid.innerHTML = videos.map(v => this.renderCard(v, isArchive)).join("");
            },
            youtube: {
                apiKey: "AIzaSyCZfKNXHgjZG1h13QhDH5-ubtVC0xDPfe4", 
                uploadsPlaylistId: "UUinvwSeMdmuuzyMWrS0tGTg", videos: [], nextPageToken: null, loading: false,
                fetchVideos: async function () {
                    if (this.loading) return; this.loading = true;
                    document.getElementById('video-loader').classList.remove('hidden');
                    let url = `https://www.googleapis.com/youtube/v3/playlistItems?key=${this.apiKey}&playlistId=${this.uploadsPlaylistId}&part=snippet&maxResults=24`;
                    if (this.nextPageToken) url += `&pageToken=${this.nextPageToken}`;
                    try {
                        const res = await fetch(url); const data = await res.json();
                        this.nextPageToken = data.nextPageToken || null;
                        this.videos.push(...data.items.map(item => ({ id: item.snippet.resourceId.videoId, title: item.snippet.title, thumbnail: item.snippet.thumbnails.high.url })));
                        if (window.app.currentVideoSource === 'youtube') window.app.renderMergedGrid();
                    } catch (e) { console.error("YT Error", e); }
                    this.loading = false; document.getElementById('video-loader').classList.add('hidden');
                }
            },

            init: function() {
                setTimeout(() => document.getElementById('app-loader').classList.add('hidden'), 1000);
                createStars();
                this.youtube.fetchVideos(); 
                this.fetchArchiveVideos(); 
                Papa.parse('catalog.csv', { download: true, header: true, skipEmptyLines: true, complete: (results) => {
                    this.data = results.data.filter(row => row['TITLE OF VIDEO']).map(row => { row.TOPIC = (row.TOPIC || "").replace(/^and\s+/i, '').trim(); return row; });
                    this.renderLibraryInterface(); 
                }});
                
                const wrapper = document.getElementById('scroll-wrapper');
                const tabs = ['home', 'library', 'videos', 'anatomy', 'meditation', 'resources'];
                let scrollTimeout;

                wrapper.addEventListener("scroll", () => {
                    if (wrapper.scrollTop + wrapper.clientHeight >= wrapper.scrollHeight - 100) {
                        if (window.app.currentVideoSource === 'youtube') window.app.youtube.fetchVideos(); else window.app.fetchArchiveVideos();
                    }
                });

                wrapper.addEventListener("wheel", (e) => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const currentView = document.querySelector('.view-section.active');
                        if(!currentView) return;
                        const currentId = currentView.id.replace('view-', '');
                        const index = tabs.indexOf(currentId);
                        
                        if (e.deltaY > 0 && Math.ceil(wrapper.scrollTop + wrapper.clientHeight) >= wrapper.scrollHeight) {
                            if (index < tabs.length - 1) window.app.nav(tabs[index + 1]);
                        }
                        else if (e.deltaY < 0 && wrapper.scrollTop === 0) {
                            if (index > 0) window.app.nav(tabs[index - 1]);
                        }
                    }, 50); 
                });
                
                this.nav('home');
            }
        };
        window.onload = () => app.init();
    </script>
</body>
</html>
