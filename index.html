<script>
/* ==========================================================
   STAR FIELD
========================================================== */
function createStars() {
    const c = document.getElementById('stars-container');
    if (!c) return;
    for (let i = 0; i < 140; i++) {
        const s = document.createElement('div');
        s.className = 'star';
        s.style.left = Math.random() * 100 + '%';
        s.style.top = Math.random() * 100 + '%';
        const size = Math.random() * 2 + 0.5;
        s.style.width = s.style.height = size + 'px';
        s.style.backgroundColor = `hsl(${Math.random()*40},80%,70%)`;
        s.style.boxShadow = `0 0 ${size*2}px ${s.style.backgroundColor}`;
        s.style.setProperty('--duration', `${Math.random()*3+2}s`);
        s.style.setProperty('--opacity', Math.random()*0.5+0.5);
        c.appendChild(s);
    }
}

/* ==========================================================
   BILL DONAHUE LANGUAGE ENGINE
========================================================== */
const BILL_ENGINE = {
    core: [
        "This is not religion.",
        "This is anatomy.",
        "This is biology.",
        "This is the nervous system.",
        "Nothing here is external.",
        "It is all happening within you."
    ],

    topics: {
        pineal: [
            "The Pineal is the Single Eye.",
            "It is the light receptor of the body.",
            "When the eye is single, the body is full of light.",
            "Light activates the gland.",
            "This is literal biology."
        ],
        jesus: [
            "Jesus is not a man.",
            "It is electrical energy.",
            "It rises up the spinal column.",
            "Born in the manger.",
            "Crucified in the skull.",
            "Resurrected in the brain."
        ],
        egypt: [
            "Egypt is a state of mind.",
            "Lower consciousness.",
            "Bondage to the senses.",
            "Moses is the mind.",
            "The Exodus is neurological."
        ],
        meditation: [
            "Be still.",
            "Shut down the five senses.",
            "Take no thought.",
            "Silence changes the current.",
            "This is how the system resets."
        ],
        bible: [
            "The Bible is not history.",
            "It is an instruction manual.",
            "Written in biological code.",
            "Every story is the body.",
            "Every symbol is the mind."
        ],
        brain: [
            "The brain is the true temple.",
            "The skull is Golgotha.",
            "The chambers are functional.",
            "This is internal architecture."
        ]
    }
};

/* ==========================================================
   UTILS
========================================================== */
function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
}

function inferTopicFromQuery(q, data) {
    const lq = q.toLowerCase();
    const hit = data.find(d =>
        lq.includes(d.TOPIC.toLowerCase().split(' ')[0])
    );
    return hit ? hit.TOPIC.toLowerCase() : null;
}

/* ==========================================================
   APP
========================================================== */
window.app = {
    data: [],

    init() {
        createStars();

        Papa.parse('catalog.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: r => {
                this.data = r.data
                    .filter(x => x['TITLE OF VIDEO'] && x.URL && x.TOPIC)
                    .map(x => ({
                        "TITLE OF VIDEO": x['TITLE OF VIDEO'].trim(),
                        "URL": x.URL.trim(),
                        "TOPIC": x.TOPIC.trim()
                    }));
                this.renderCategories();
                document.getElementById('status-bar').innerText =
                    `${this.data.length} Records Online`;
            }
        });

        this.nav('home');
        setTimeout(() => document.getElementById('app-loader').classList.add('hidden'), 300);
    },

    getUniqueTopics() {
        return [...new Set(this.data.map(d => d.TOPIC))].sort();
    },

    renderCategories() {
        const t = this.getUniqueTopics();
        document.getElementById('total-topics-display').innerText =
            `${t.length} Categories`;

        document.getElementById('category-grid').innerHTML = t.map((x,i)=>`
            <div onclick="app.openTopic('${x.replace(/'/g,"\\'")}')" class="cosmos-card p-6">
                <div class="text-xs text-gray-500 mb-3">0${i+1}</div>
                <div class="text-sm text-white">${x}</div>
            </div>
        `).join('');
    },

    openTopic(topic) {
        this.nav('list');
        document.getElementById('active-category-title').innerText = topic;
        const items = this.data.filter(d => d.TOPIC === topic);
        document.getElementById('active-category-count').innerText =
            `${items.length} Lectures`;

        document.getElementById('list-container').innerHTML = items.map(l=>`
            <div class="p-4 border border-white/10 rounded flex justify-between">
                <span>${l['TITLE OF VIDEO']}</span>
                ${l.URL.includes('http') ? `<a href="${l.URL}" target="_blank">Watch</a>` : ''}
            </div>
        `).join('');
    },

    search(q) {
        if (!q) return this.nav('library');
        this.nav('search');
        document.getElementById('ai-box').style.display = 'none';

        const r = this.data.filter(d =>
            d['TITLE OF VIDEO'].toLowerCase().includes(q.toLowerCase()) ||
            d.TOPIC.toLowerCase().includes(q.toLowerCase())
        );

        document.getElementById('search-list').innerHTML = r.map(x=>`
            <div class="p-4 border-b border-white/10">
                <div class="text-xs text-gray-500">${x.TOPIC}</div>
                <div>${x['TITLE OF VIDEO']}</div>
            </div>
        `).join('');
    },

    /* ==========================================================
       ADVANCED AI RESPONSE (BILL ENGINE)
    ========================================================== */
    performAISearch() {
        const q = document.getElementById('ai-input').value;
        if (!q) return;

        this.nav('search');
        this.search(q);

        const box = document.getElementById('ai-box');
        const out = document.getElementById('ai-text-output');
        box.style.display = 'block';
        out.innerText = "â€¦";

        setTimeout(() => {
            const lq = q.toLowerCase();
            let bank = [];

            Object.keys(BILL_ENGINE.topics).forEach(k => {
                if (lq.includes(k)) bank = BILL_ENGINE.topics[k];
            });

            if (bank.length === 0) {
                const inferred = inferTopicFromQuery(q, this.data);
                if (inferred && BILL_ENGINE.topics[inferred.split(' ')[0]]) {
                    bank = BILL_ENGINE.topics[inferred.split(' ')[0]];
                }
            }

            if (bank.length === 0) bank = BILL_ENGINE.core;

            const response = [
                ...shuffle(bank).slice(0, 4),
                ...shuffle(BILL_ENGINE.core).slice(0, 2)
            ].join(" ");

            out.innerText = response;
        }, 1100);
    },

    nav(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        window.scrollTo(0,0);
    }
};

window.onload = () => app.init();
</script>
