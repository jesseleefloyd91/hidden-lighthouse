<script>
/* =========================
   STAR FIELD
========================= */
function createStars() {
    const container = document.getElementById('stars-container');
    if (!container) return;
    for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = `${Math.random() * 100}%`;
        star.style.top = `${Math.random() * 100}%`;
        const size = Math.random() * 2 + 0.5;
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.backgroundColor = `hsl(${Math.random() * 40}, 80%, 70%)`;
        star.style.boxShadow = `0 0 ${size * 2}px ${star.style.backgroundColor}`;
        star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
        star.style.setProperty('--opacity', Math.random() * 0.5 + 0.5);
        container.appendChild(star);
    }
}

/* =========================
   APP CORE
========================= */
window.app = {
    data: [],

    /* ---- CLEAN FALLBACK CSV (must be valid) ---- */
    rawCSV: `TITLE OF VIDEO,URL,TOPIC
911 UNANSWERED PRAYER ON 911,https://www.youtube.com/watch?v=-N_e18xe9sE,911
2012 AND BEYOND A WHOLE LOT OF SHAKING GOING ON,https://www.youtube.com/watch?v=mpgOVQ1Xwwc,2012 & BEYOND`,

    init() {
        createStars();
        this.setupStarInteractions();

        Papa.parse('catalog.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                this.data = results.data
                    .filter(r => r['TITLE OF VIDEO'] && r.URL && r.TOPIC)
                    .map(r => ({
                        "TITLE OF VIDEO": r['TITLE OF VIDEO'].trim(),
                        "URL": r.URL.trim(),
                        "TOPIC": r.TOPIC.trim()
                    }));

                this.renderCategories();
                document.getElementById('status-bar').innerText =
                    `${this.data.length} Records Online`;
            },
            error: () => {
                this.processRawCSV();
            }
        });

        this.nav('home');
        setTimeout(() => document.getElementById('app-loader').classList.add('hidden'), 300);
    },

    processRawCSV() {
        Papa.parse(this.rawCSV, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                this.data = results.data.filter(r => r['TITLE OF VIDEO']);
                this.renderCategories();
            }
        });
    },

    /* =========================
       STAR INTERACTION FX
    ========================= */
    setupStarInteractions() {
        let lastMove = 0;
        document.addEventListener('mousemove', e => {
            if (Date.now() - lastMove < 100) return;
            lastMove = Date.now();
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = `${e.clientX}px`;
            star.style.top = `${e.clientY}px`;
            star.style.width = '2px';
            star.style.height = '2px';
            star.style.backgroundColor = 'hsl(30,80%,70%)';
            star.style.opacity = 0.8;
            star.style.transition = 'opacity 1s ease';
            setTimeout(() => {
                star.style.opacity = 0;
                setTimeout(() => star.remove(), 1000);
            }, 10);
            document.getElementById('stars-container').appendChild(star);
        });
    },

    /* =========================
       DATA + UI
    ========================= */
    getUniqueTopics() {
        return [...new Set(this.data.map(d => d.TOPIC))].sort();
    },

    getIcon(topic) {
        const t = topic.toLowerCase();
        if (t.includes('astro')) return 'fa-meteor';
        if (t.includes('bible')) return 'fa-book-bible';
        if (t.includes('brain') || t.includes('mind')) return 'fa-brain';
        if (t.includes('meditation')) return 'fa-om';
        if (t.includes('jesus')) return 'fa-cross';
        return 'fa-star';
    },

    renderCategories() {
        const topics = this.getUniqueTopics();
        document.getElementById('total-topics-display').innerText =
            `${topics.length} Categories`;

        document.getElementById('category-grid').innerHTML = topics.map((t, i) => {
            const count = this.data.filter(d => d.TOPIC === t).length;
            return `
                <div onclick="app.openTopic('${t.replace(/'/g,"\\'")}')" class="cosmos-card p-6">
                    <div class="flex justify-between mb-4">
                        <span class="text-xs text-gray-500">0${i + 1}</span>
                        <i class="fa-solid ${this.getIcon(t)} text-gray-500"></i>
                    </div>
                    <h3 class="text-sm text-gray-200 mb-6">${t}</h3>
                    <div class="text-[9px] text-gray-500 uppercase">${count} Items</div>
                </div>`;
        }).join('');
    },

    openTopic(topic) {
        this.nav('list');
        document.getElementById('active-category-title').innerText = topic;
        const items = this.data.filter(d => d.TOPIC === topic);
        document.getElementById('active-category-count').innerText =
            `${items.length} Lectures`;

        document.getElementById('list-container').innerHTML = items.map(l => `
            <div class="p-4 border border-white/10 rounded flex justify-between">
                <span>${l['TITLE OF VIDEO']}</span>
                ${l.URL.includes('http')
                    ? `<a href="${l.URL}" target="_blank">Watch</a>`
                    : `<span>Pending</span>`}
            </div>
        `).join('');
    },

    search(q) {
        if (!q) return this.nav('library');
        this.nav('search');
        document.getElementById('ai-box').style.display = 'none';

        const res = this.data.filter(d =>
            d['TITLE OF VIDEO'].toLowerCase().includes(q.toLowerCase()) ||
            d.TOPIC.toLowerCase().includes(q.toLowerCase())
        );

        document.getElementById('search-list').innerHTML = res.map(r => `
            <div class="p-4 border-b border-white/10">
                <div class="text-xs text-gray-500">${r.TOPIC}</div>
                <div>${r['TITLE OF VIDEO']}</div>
            </div>
        `).join('');
    },

    /* =========================
       BILL-STYLE AI RESPONSE
    ========================= */
    performAISearch() {
        const q = document.getElementById('ai-input').value;
        if (!q) return;

        this.nav('search');
        this.search(q);

        const out = document.getElementById('ai-text-output');
        const box = document.getElementById('ai-box');
        box.style.display = 'block';
        out.innerText = "Consulting the archives...";

        setTimeout(() => {
            const lq = q.toLowerCase();
            let resp = "";

            if (lq.includes('pineal') || lq.includes('eye')) {
                resp = "The Pineal is the Single Eye. Period. This is the light receptor of the body. When your eye is single, the whole body is full of light. This is anatomy â€” not religion.";
            } else if (lq.includes('jesus')) {
                resp = "Jesus is not a man. It is a function. Electrical energy rising up the spine. Born in the manger. Crucified in the skull. Resurrected in the brain.";
            } else if (lq.includes('egypt')) {
                resp = "Egypt is a state of mind. Lower consciousness. Bondage to the senses. The Exodus is neurological. Moses is the mind.";
            } else if (lq.includes('meditation') || lq.includes('silence')) {
                resp = "Be still. Shut down the senses. Take no thought. Silence is where the current changes direction.";
            } else {
                resp = "All scripture is biology. All mythology is the mind. Nothing is external. It is all happening within you.";
            }

            out.innerText = resp;
        }, 1200);
    },

    nav(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${id}`).classList.add('active');
        window.scrollTo(0, 0);
    }
};

window.onload = () => app.init();
</script>
